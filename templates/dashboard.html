{% extends 'base.html' %}
{% block title %}Dashboard - UFW Web Manager{% endblock %}
{% block content %}
<div class="grid two">
    <div class="card status-tile" style="min-height:180px;">
        <h2 style="margin:0 0 12px; font-size:20px; display:flex; gap:8px; align-items:center;">ðŸ”¥ Firewall Status</h2>
        <div class="status-pill {{ 'active' if status.active else 'inactive' }}">
            {{ 'ACTIVE' if status.active else 'INACTIVE' }}
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="btn btn-primary" onclick="toggleUFW('enable')">ðŸŸ¢ Enable</button>
            <button class="btn btn-danger" onclick="toggleUFW('disable')">ðŸ”´ Disable</button>
            <button class="btn btn-warning" onclick="resetUFW()">ðŸ”„ Reset</button>
        </div>
    </div>
    <div class="card" style="min-height:180px;">
        <h2 style="margin:0 0 16px; font-size:20px; display:flex; gap:8px; align-items:center;">âž• Add Rule</h2>
        <form onsubmit="addRule(event)" autocomplete="off" novalidate>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:14px 18px;">
                <div class="form-row" style="margin:0;">
                    <label>Direction</label>
                    <select id="direction" required>
                        <option value="in">Inbound</option>
                        <option value="out">Outbound</option>
                    </select>
                </div>
                <div class="form-row" style="margin:0;">
                    <label>Action</label>
                    <select id="action" required>
                        <option value="allow">Allow</option>
                        <option value="deny">Deny</option>
                    </select>
                </div>
                <div class="form-row" style="margin:0;">
                    <label>Net Proto</label>
                    <select id="net_protocol" onchange="updateIPFields()" required>
                        <option value="any">Any</option>
                        <option value="ipv4">IPv4</option>
                        <option value="ipv6">IPv6</option>
                    </select>
                </div>
                <div class="form-row" style="margin:0;">
                    <label>Transport</label>
                    <select id="transport_protocol" required>
                        <option value="any">Any</option>
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                    </select>
                </div>
                <div class="form-row" style="margin:0;">
                    <label>Port / Range</label>
                    <input type="text" id="port" placeholder="22 / 80 / 1000:2000" required />
                </div>
                <div class="form-row" style="margin:0;">
                    <label>Source IP</label>
                    <input type="text" id="source_ip" placeholder="any" />
                </div>
                <div class="form-row" style="margin:0;">
                    <label>Dest IP</label>
                    <input type="text" id="dest_ip" placeholder="any" />
                </div>
                <div class="form-row" style="grid-column: 1 / -1; margin:0;">
                    <label>Comment</label>
                    <input type="text" id="comment" placeholder="Optional" />
                </div>
            </div>
            <small class="help" id="source_ip_help">IPv4: 192.168.1.0/24 or 10.0.0.1 | IPv6: 2001:db8::/32 or ::1</small>
            <small class="help" id="dest_ip_help" style="margin-top:4px;">IPv4: 192.168.1.0/24 or 10.0.0.1 | IPv6: 2001:db8::/32 or ::1</small>
            <div style="display:flex; justify-content:flex-end; margin-top:18px;">
                <button type="submit" class="btn btn-primary">Add Rule</button>
            </div>
        </form>
    </div>
</div>
<hr class="divider" />
<div class="rule-groups">
    <div class="card rule-list-card">
        <h3>Inbound Rules</h3>
        {% set inbound = status.inbound_rules if status.inbound_rules is defined else (status.numbered_rules if status.numbered_rules is defined else []) %}
        {% if inbound and inbound|length > 0 %}
            {% for rule in inbound %}
            <div class="rule-item">
                <div class="num">#{{ rule.number }}</div>
                <div class="text" style="white-space: pre-line;">{{ rule.rule }}</div>
                <div class="actions">
                    <button class="btn btn-danger btn-small" onclick="deleteRule('{{ rule.number }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty">No inbound rules</div>
        {% endif %}
    </div>
    <div class="card rule-list-card">
        <h3>Outbound Rules</h3>
        {% set outbound = status.outbound_rules if status.outbound_rules is defined else [] %}
        {% if outbound and outbound|length > 0 %}
            {% for rule in outbound %}
            <div class="rule-item">
                <div class="num">#{{ rule.number }}</div>
                <div class="text" style="white-space: pre-line;">{{ rule.rule }}</div>
                <div class="actions">
                    <button class="btn btn-danger btn-small" onclick="deleteRule('{{ rule.number }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty">No outbound rules</div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function toggleUFW(action) {
        if (confirm(`Are you sure you want to ${action} UFW?`)) {
            fetch('/api/toggle', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        }
    }
    
    function resetUFW() {
        if (confirm('Are you sure you want to reset UFW? This will remove all rules!')) {
            fetch('/api/reset', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
            });
        }
    }
    
    function addRule(event) {
        event.preventDefault();
        
        const direction = document.getElementById('direction').value;
        const action = document.getElementById('action').value;
        const net_protocol = document.getElementById('net_protocol').value;
        const transport_protocol = document.getElementById('transport_protocol').value;
        const port = document.getElementById('port').value;
        const source_ip = document.getElementById('source_ip').value || 'any';
        const dest_ip = document.getElementById('dest_ip').value || 'any';
        const comment = document.getElementById('comment').value;
        
        // Basic validation
        if (!port.trim()) {
            alert('Port is required');
            return;
        }
        
        // Validate IP addresses based on selected protocol
        if (net_protocol === 'ipv4') {
            if (source_ip !== 'any' && !isValidIPv4(source_ip)) {
                alert('Invalid IPv4 source address');
                return;
            }
            if (dest_ip !== 'any' && !isValidIPv4(dest_ip)) {
                alert('Invalid IPv4 destination address');
                return;
            }
        } else if (net_protocol === 'ipv6') {
            if (source_ip !== 'any' && !isValidIPv6(source_ip)) {
                alert('Invalid IPv6 source address');
                return;
            }
            if (dest_ip !== 'any' && !isValidIPv6(dest_ip)) {
                alert('Invalid IPv6 destination address');
                return;
            }
        }
        
        fetch('/api/add_rule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                direction: direction,
                action: action,
                net_protocol: net_protocol,
                transport_protocol: transport_protocol,
                port: port,
                source_ip: source_ip,
                dest_ip: dest_ip,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Network error: ' + error);
        });
    }
    
    function deleteRule(ruleNumber) {
        if (confirm(`Are you sure you want to delete rule #${ruleNumber}?`)) {
            // Show loading state
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = 'â³ Deleting...';
            button.disabled = true;
            
            fetch('/api/delete_rule', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    rule_number: ruleNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message briefly before reload
                    button.innerHTML = 'âœ… Deleted';
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert('Error deleting rule: ' + data.error);
                    // Restore button state
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                alert('Network error: ' + error);
                // Restore button state
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }
    }
    
    function updateIPFields() {
        const netProtocol = document.getElementById('net_protocol').value;
        const sourceHelp = document.getElementById('source_ip_help');
        const destHelp = document.getElementById('dest_ip_help');
        
        if (netProtocol === 'ipv4') {
            sourceHelp.textContent = 'IPv4 format: 192.168.1.0/24, 10.0.0.1, or leave empty for any';
            destHelp.textContent = 'IPv4 format: 192.168.1.0/24, 10.0.0.1, or leave empty for any';
        } else if (netProtocol === 'ipv6') {
            sourceHelp.textContent = 'IPv6 format: 2001:db8::/32, ::1, or leave empty for any';
            destHelp.textContent = 'IPv6 format: 2001:db8::/32, ::1, or leave empty for any';
        } else {
            sourceHelp.textContent = 'Any format: IPv4 (192.168.1.0/24) or IPv6 (2001:db8::/32)';
            destHelp.textContent = 'Any format: IPv4 (192.168.1.0/24) or IPv6 (2001:db8::/32)';
        }
    }
    
    function isValidIPv4(ip) {
        // Basic IPv4 validation with CIDR support
        const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
        if (!ipv4Regex.test(ip)) return false;
        
        const parts = ip.split('/')[0].split('.');
        return parts.every(part => {
            const num = parseInt(part, 10);
            return num >= 0 && num <= 255;
        });
    }
    
    function isValidIPv6(ip) {
        // Basic IPv6 validation with CIDR support
        const ipv6Regex = /^([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}(\/\d{1,3})?$|^::1$|^::$/;
        return ipv6Regex.test(ip);
    }
    
    // Auto-refresh status every 60 seconds (extended due to flash overlay UX)
    setTimeout(() => location.reload(), 60000);
</script>
{% endblock %}
