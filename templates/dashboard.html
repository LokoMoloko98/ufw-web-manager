{% extends 'base.html' %}
{% block title %}Dashboard - UFW Web Manager{% endblock %}
{% block content %}
<div class="grid two">
    <div class="card status-tile" style="min-height:180px;">
        <h2 style="margin:0 0 12px; font-size:20px; display:flex; gap:8px; align-items:center;">üî• Firewall Status</h2>
        <div class="status-pill {{ 'active' if status.active else 'inactive' }}">
            {{ 'ACTIVE' if status.active else 'INACTIVE' }}
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
            <button class="btn btn-primary" onclick="toggleUFW('enable')">üü¢ Enable</button>
            <button class="btn btn-danger" onclick="toggleUFW('disable')">üî¥ Disable</button>
            <button class="btn btn-warning" onclick="resetUFW()">üîÑ Reset</button>
        </div>
    </div>
    <div class="card" style="min-height:180px;">
        <h2 style="margin:0 0 16px; font-size:20px; display:flex; gap:8px; align-items:center;">‚ûï Add Rule</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 0 0 14px;">
            <button class="btn btn-outline btn-small" type="button" onclick="applyPreset('ssh')">SSH</button>
            <button class="btn btn-outline btn-small" type="button" onclick="applyPreset('http')">HTTP</button>
            <button class="btn btn-outline btn-small" type="button" onclick="applyPreset('https')">HTTPS</button>
            <button class="btn btn-outline btn-small" type="button" onclick="applyPreset('dns')">DNS</button>
            <button class="btn btn-outline btn-small" type="button" onclick="applyPreset('ntp')">NTP</button>
        </div>
        <form onsubmit="addRule(event)" autocomplete="off" novalidate id="addRuleForm">
            <fieldset style="border:none; padding:0; margin:0 0 12px;">
                <legend style="font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--color-text-muted); margin-bottom:6px;">Core</legend>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px,1fr)); gap:14px 18px;">
                    <div class="form-row" style="margin:0;">
                        <label>Direction</label>
                        <select id="direction" required>
                            <option value="in">Inbound</option>
                            <option value="out">Outbound</option>
                        </select>
                    </div>
                    <div class="form-row" style="margin:0;">
                        <label>Action</label>
                        <select id="action" required>
                            <option value="allow">Allow</option>
                            <option value="deny">Deny</option>
                        </select>
                    </div>
                    <div class="form-row" style="margin:0;">
                        <label>Net Proto</label>
                        <select id="net_protocol" onchange="updateIPFields()" required>
                            <option value="any">Any</option>
                            <option value="ipv4">IPv4</option>
                            <option value="ipv6">IPv6</option>
                        </select>
                    </div>
                    <div class="form-row" style="margin:0;">
                        <label>Transport</label>
                        <select id="transport_protocol" required>
                            <option value="any">Any</option>
                            <option value="tcp">TCP</option>
                            <option value="udp">UDP</option>
                        </select>
                    </div>
                    <div class="form-row" style="margin:0;">
                        <label>Port / Range</label>
                        <input type="text" id="port" required />
                        <small class="help field-error" id="port_error" style="display:none; color:var(--color-danger);">Invalid port format</small>
                    </div>
                </div>
            </fieldset>
            <fieldset style="border:none; padding:0; margin:0 0 14px;">
                <legend style="font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--color-text-muted); margin-bottom:6px;">Endpoints</legend>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:14px 18px;">
                    <div class="form-row" style="margin:0;">
                        <label>Source IP</label>
                        <input type="text" id="source_ip" />
                        <small class="help field-error" id="source_error" style="display:none; color:var(--color-danger);">Invalid source address</small>
                    </div>
                    <div class="form-row" style="margin:0;">
                        <label>Dest IP</label>
                        <input type="text" id="dest_ip" />
                        <small class="help field-error" id="dest_error" style="display:none; color:var(--color-danger);">Invalid destination address</small>
                    </div>
                </div>
            </fieldset>
            <fieldset style="border:none; padding:0; margin:0 0 6px;">
                <legend style="font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--color-text-muted); margin-bottom:6px;">Meta</legend>
                <div class="form-row" style="margin:0;">
                    <label>Comment</label>
                    <input type="text" id="comment" />
                </div>
            </fieldset>
            <small class="help" id="source_ip_help">IPv4: 192.168.1.0/24 or 10.0.0.1 | IPv6: 2001:db8::/32 or ::1</small>
            <small class="help" id="dest_ip_help" style="margin-top:4px;">IPv4: 192.168.1.0/24 or 10.0.0.1 | IPv6: 2001:db8::/32 or ::1</small>
            <div style="display:flex; justify-content:space-between; gap:10px; margin-top:18px;">
                <button type="reset" class="btn btn-ghost" onclick="clearErrors()">Reset</button>
                <button type="submit" class="btn btn-primary" id="addRuleBtn">Add Rule</button>
            </div>
        </form>
    </div>
</div>
<hr class="divider" />
<div class="rule-groups">
    <div class="card rule-list-card">
        <h3>Inbound Rules</h3>
        {% set inbound = status.inbound_rules if status.inbound_rules is defined else (status.numbered_rules if status.numbered_rules is defined else []) %}
        {% if inbound and inbound|length > 0 %}
            {% for rule in inbound %}
            <div class="rule-item" data-rule-number="{{ rule.number }}">
                <div class="num">#{{ rule.number }}</div>
                <div class="text" style="white-space: pre-line;" data-original="{{ rule.rule }}">{{ rule.rule }}</div>
                <div class="actions">
                    <button class="btn btn-outline btn-small" type="button" onclick="enterEdit(this)">‚úèÔ∏è Edit</button>
                    <button class="btn btn-danger btn-small" onclick="deleteRule('{{ rule.number }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty">No inbound rules</div>
        {% endif %}
    </div>
    <div class="card rule-list-card">
        <h3>Outbound Rules</h3>
        {% set outbound = status.outbound_rules if status.outbound_rules is defined else [] %}
        {% if outbound and outbound|length > 0 %}
            {% for rule in outbound %}
            <div class="rule-item" data-rule-number="{{ rule.number }}">
                <div class="num">#{{ rule.number }}</div>
                <div class="text" style="white-space: pre-line;" data-original="{{ rule.rule }}">{{ rule.rule }}</div>
                <div class="actions">
                    <button class="btn btn-outline btn-small" type="button" onclick="enterEdit(this)">‚úèÔ∏è Edit</button>
                    <button class="btn btn-danger btn-small" onclick="deleteRule('{{ rule.number }}')">Delete</button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty">No outbound rules</div>
        {% endif %}
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    function toggleUFW(action) {
        ThemedModal.confirm({
            title: (action==='enable'?'Enable Firewall':'Disable Firewall'),
            body: action==='enable' ? 'This will enable UFW and start enforcing configured rules.' : 'This will disable UFW. Active protections will be lifted until re-enabled. Proceed?',
            danger: action!=='enable',
            confirmText: action==='enable'?'Enable':'Disable',
            onConfirm: () => {
                fetch('/api/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({action: action})
                })
                .then(r=>r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        ThemedModal.alert({ title:'Operation Failed', body: data.error || 'Unknown error' });
                    }
                })
                .catch(err => ThemedModal.alert({ title:'Network Error', body: err.toString() }));
            }
        });
    }
    
    function resetUFW() {
        ThemedModal.confirm({
            title: 'Reset Firewall',
            body: 'This will REMOVE all existing UFW rules and restore defaults. This cannot be undone. Continue?',
            danger: true,
            confirmText: 'Reset',
            onConfirm: () => {
                fetch('/api/reset', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                })
                .then(r=>r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        ThemedModal.alert({ title:'Reset Failed', body: data.error || 'Unknown error' });
                    }
                })
                .catch(err => ThemedModal.alert({ title:'Network Error', body: err.toString() }));
            }
        });
    }
    
    function showFieldError(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'block';
    }
    function hideFieldError(id) {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    }
    function clearErrors() {
        ['port_error','source_error','dest_error'].forEach(hideFieldError);
    }
    function applyPreset(name) {
        clearErrors();
        const map = {
            ssh: {port:'22', transport:'tcp', action:'allow', comment:'SSH'},
            http: {port:'80', transport:'tcp', action:'allow', comment:'HTTP'},
            https: {port:'443', transport:'tcp', action:'allow', comment:'HTTPS'},
            dns: {port:'53', transport:'udp', action:'allow', comment:'DNS'},
            ntp: {port:'123', transport:'udp', action:'allow', comment:'NTP'}
        };
        const p = map[name]; if(!p) return;
        document.getElementById('port').value = p.port;
        document.getElementById('transport_protocol').value = p.transport;
        document.getElementById('action').value = p.action;
        document.getElementById('comment').value = p.comment;
    }
    function addRule(event) {
        event.preventDefault();
        
        const direction = document.getElementById('direction').value;
        const action = document.getElementById('action').value;
        const net_protocol = document.getElementById('net_protocol').value;
        const transport_protocol = document.getElementById('transport_protocol').value;
        const port = document.getElementById('port').value;
        const source_ip = document.getElementById('source_ip').value || 'any';
        const dest_ip = document.getElementById('dest_ip').value || 'any';
        const comment = document.getElementById('comment').value;
        
        // Basic validation
        clearErrors();
    if (!port.trim()) { showFieldError('port_error'); ThemedModal.alert({title:'Validation', body:'Port is required.'}); return; }
    if (!/^([0-9a-zA-Z:_-]+)$/.test(port.trim()) ) { showFieldError('port_error'); ThemedModal.alert({title:'Validation', body:'Invalid port format.'}); return; }
        
        // Validate IP addresses based on selected protocol
        if (net_protocol === 'ipv4') {
            if (source_ip !== 'any' && !isValidIPv4(source_ip)) { showFieldError('source_error'); ThemedModal.alert({title:'Validation', body:'Invalid IPv4 source address.'}); return; }
            if (dest_ip !== 'any' && !isValidIPv4(dest_ip)) { showFieldError('dest_error'); ThemedModal.alert({title:'Validation', body:'Invalid IPv4 destination address.'}); return; }
        } else if (net_protocol === 'ipv6') {
            if (source_ip !== 'any' && !isValidIPv6(source_ip)) { showFieldError('source_error'); ThemedModal.alert({title:'Validation', body:'Invalid IPv6 source address.'}); return; }
            if (dest_ip !== 'any' && !isValidIPv6(dest_ip)) { showFieldError('dest_error'); ThemedModal.alert({title:'Validation', body:'Invalid IPv6 destination address.'}); return; }
        }
        
        const btn = document.getElementById('addRuleBtn');
        const originalLabel = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Adding...';
        fetch('/api/add_rule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                direction: direction,
                action: action,
                net_protocol: net_protocol,
                transport_protocol: transport_protocol,
                port: port,
                source_ip: source_ip,
                dest_ip: dest_ip,
                comment: comment
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                btn.innerHTML = '‚úÖ Added';
                setTimeout(() => location.reload(), 700);
            } else {
                btn.innerHTML = originalLabel;
                btn.disabled = false;
                ThemedModal.alert({title:'Add Rule Failed', body: data.error || 'Unknown error'});
            }
        })
        .catch(error => {
            btn.innerHTML = originalLabel;
            btn.disabled = false;
            ThemedModal.alert({title:'Network Error', body: error.toString()});
        });
    }

    function enterEdit(button) {
        const item = button.closest('.rule-item');
        if(!item) return;
        const textDiv = item.querySelector('.text');
        const original = textDiv.getAttribute('data-original');
        if (item.classList.contains('editing')) return;
        item.classList.add('editing');
        // Very lightweight parse: user can only change comment & action by recreating rule.
        const number = item.getAttribute('data-rule-number');
        const formHtml = `\n            <div style="display:flex; flex-direction:column; gap:6px; width:100%;">\n              <textarea style=\"width:100%; min-height:60px; background:#222427; color:var(--color-text); border:1px solid var(--color-border-soft); border-radius:6px; padding:8px; font-family:inherit; font-size:12px;\" disabled>${original}</textarea>\n              <div style=\"display:flex; gap:6px;\">\n                <input type=\"text\" placeholder=\"New comment (optional)\" style=\"flex:1; background:#222427; color:var(--color-text); border:1px solid var(--color-border-soft); border-radius:6px; padding:8px; font-size:12px;\" class=\"edit-comment-input\" />\n                <select class=\"edit-action-select\" style=\"background:#222427; color:var(--color-text); border:1px solid var(--color-border-soft); border-radius:6px; padding:8px; font-size:12px;\">\n                  <option value=\"allow\">allow</option>\n                  <option value=\"deny\">deny</option>\n                </select>\n              </div>\n              <div style=\"display:flex; gap:8px; justify-content:flex-end;\">\n                <button type=\"button\" class=\"btn btn-primary btn-small\" onclick=\"saveEdit('${number}', this)\">Save</button>\n                <button type=\"button\" class=\"btn btn-ghost btn-small\" onclick=\"cancelEdit(this)\">Cancel</button>\n              </div>\n            </div>`;
        textDiv.innerHTML = formHtml;
    }
    function cancelEdit(btn) {
        const item = btn.closest('.rule-item');
        const textDiv = item.querySelector('.text');
        textDiv.innerText = textDiv.getAttribute('data-original');
        item.classList.remove('editing');
    }
    function saveEdit(number, btn) {
        // Placeholder: for now we alert user that true inline editing requires parsing rule details.
        const item = btn.closest('.rule-item');
        const commentInput = item.querySelector('.edit-comment-input');
        const actionSelect = item.querySelector('.edit-action-select');
        const newComment = (commentInput.value || '').trim();
        const newAction = actionSelect.value;
        if(!confirm('This will re-create the rule with modified action/comment (original will be deleted). Proceed?')) return;
        btn.disabled = true; btn.innerHTML = '‚è≥';
        // Strategy: delete existing rule then add new one is complex (need to parse original). For now just notify.
        alert('Inline full edit not yet implemented (comment/action capture stubbed).');
        btn.disabled = false; btn.innerHTML = 'Save';
    }
    
    function deleteRule(ruleNumber) {
        ThemedModal.confirm({
            title: 'Delete Rule',
            body: `Delete firewall rule #${ruleNumber}? This cannot be undone.`,
            danger: true,
            confirmText: 'Delete',
            onConfirm: () => {
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '‚è≥ Deleting...';
                button.disabled = true;
                fetch('/api/delete_rule', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ rule_number: ruleNumber })
                })
                .then(r=>r.json())
                .then(data => {
                    if (data.success) {
                        button.innerHTML = '‚úÖ Deleted';
                        setTimeout(()=>location.reload(), 800);
                    } else {
                        button.innerHTML = originalText;
                        button.disabled = false;
                        ThemedModal.alert({title:'Delete Failed', body: data.error || 'Unknown error'});
                    }
                })
                .catch(err => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    ThemedModal.alert({title:'Network Error', body: err.toString()});
                });
            }
        });
    }
    
    function updateIPFields() {
        const netProtocol = document.getElementById('net_protocol').value;
        const sourceHelp = document.getElementById('source_ip_help');
        const destHelp = document.getElementById('dest_ip_help');
        
        if (netProtocol === 'ipv4') {
            sourceHelp.textContent = 'IPv4 format: 192.168.1.0/24, 10.0.0.1, or leave empty for any';
            destHelp.textContent = 'IPv4 format: 192.168.1.0/24, 10.0.0.1, or leave empty for any';
        } else if (netProtocol === 'ipv6') {
            sourceHelp.textContent = 'IPv6 format: 2001:db8::/32, ::1, or leave empty for any';
            destHelp.textContent = 'IPv6 format: 2001:db8::/32, ::1, or leave empty for any';
        } else {
            sourceHelp.textContent = 'Any format: IPv4 (192.168.1.0/24) or IPv6 (2001:db8::/32)';
            destHelp.textContent = 'Any format: IPv4 (192.168.1.0/24) or IPv6 (2001:db8::/32)';
        }
    }
    
    function isValidIPv4(ip) {
        // Basic IPv4 validation with CIDR support
        const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}(\/\d{1,2})?$/;
        if (!ipv4Regex.test(ip)) return false;
        
        const parts = ip.split('/')[0].split('.');
        return parts.every(part => {
            const num = parseInt(part, 10);
            return num >= 0 && num <= 255;
        });
    }
    
    function isValidIPv6(ip) {
        // Basic IPv6 validation with CIDR support
        const ipv6Regex = /^([0-9a-fA-F]{0,4}:){1,7}[0-9a-fA-F]{0,4}(\/\d{1,3})?$|^::1$|^::$/;
        return ipv6Regex.test(ip);
    }
    
    // Auto-refresh status every 60 seconds (extended due to flash overlay UX)
    setTimeout(() => location.reload(), 60000);
</script>
{% endblock %}
